name: Release Build

on:
  release:
    types: [published]

jobs:
  # macOS build with code signing and notarization
  build-macos:
    permissions:
      contents: write
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-${{ runner.os }}-

      - name: Cache frontend build
        id: frontend-cache
        uses: actions/cache@v4
        with:
          path: dist
          key: frontend-${{ runner.os }}-${{ hashFiles('src/**', 'package-lock.json', 'vite.config.ts') }}
          restore-keys: frontend-${{ runner.os }}-

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Configure sccache
        run: |
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          shared-key: "macos-universal-v1"
          save-if: true
          cache-all-crates: true

      - name: Import signing certificate
        run: |
          echo "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

      - name: Install frontend dependencies
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build frontend
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        run: npm run build

      - name: Build Tauri app
        run: npm run tauri build -- --target universal-apple-darwin --bundles app

      - name: Find app bundle
        id: find-app
        run: |
          APP_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app" | head -1)
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Sign app bundle
        run: |
          # Re-unlock keychain in case it locked during build
          security unlock-keychain -p "" build.keychain

          # Sign the app bundle with hardened runtime and timestamp
          codesign --sign "Developer ID Application" \
            --deep \
            --force \
            --options runtime \
            --timestamp \
            --identifier "com.bluebuzzah.updater" \
            "${{ steps.find-app.outputs.app_path }}"

          # Verify signature
          codesign --verify --deep --strict "${{ steps.find-app.outputs.app_path }}"

      - name: Create signed DMG
        run: |
          # Create DMG from signed app
          APP_PATH="${{ steps.find-app.outputs.app_path }}"
          APP_NAME=$(basename "$APP_PATH" .app)
          APP_NAME_CLEAN="${APP_NAME// /_}"
          DMG_PATH="src-tauri/target/universal-apple-darwin/release/bundle/dmg/${APP_NAME_CLEAN}_universal.dmg"
          mkdir -p "$(dirname "$DMG_PATH")"

          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_PATH"

          # Sign the DMG
          codesign --sign "Developer ID Application" --timestamp "$DMG_PATH"
          codesign --verify "$DMG_PATH"

      - name: Find DMG file
        id: find-dmg
        run: |
          DMG_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ./private_keys
          KEY_FILE=./private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          printf '%s' "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 --decode > "$KEY_FILE"

          # Store credentials in keychain (avoids direct key file access crash)
          xcrun notarytool store-credentials "notary-profile" \
            --key "$KEY_FILE" \
            --key-id "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            --issuer "${{ secrets.APP_STORE_CONNECT_API_ISSUER }}"

      - name: Notarize DMG
        id: notarize
        run: |
          # Submit and capture output
          OUTPUT=$(xcrun notarytool submit "${{ steps.find-dmg.outputs.dmg_path }}" \
            --keychain-profile "notary-profile" \
            --wait 2>&1) || true
          echo "$OUTPUT"

          # Extract submission ID
          SUBMISSION_ID=$(echo "$OUTPUT" | grep -o 'id: [a-f0-9-]*' | head -1 | cut -d' ' -f2)
          echo "submission_id=$SUBMISSION_ID" >> $GITHUB_OUTPUT

          # Check if successful
          if echo "$OUTPUT" | grep -q "status: Accepted"; then
            echo "Notarization successful!"
          else
            echo "Notarization failed. Fetching log..."
            xcrun notarytool log "$SUBMISSION_ID" --keychain-profile "notary-profile" || true
            exit 1
          fi

      - name: Staple DMG
        run: |
          xcrun stapler staple "${{ steps.find-dmg.outputs.dmg_path }}"

      - name: Report sccache stats
        if: always()
        run: sccache --show-stats

      - name: Upload macOS DMG to release
        uses: softprops/action-gh-release@v2
        with:
          files: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup sensitive files
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f certificate.p12
          rm -rf ./private_keys

  # Windows build (uses tauri-action for automatic upload)
  build-windows:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~\.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-${{ runner.os }}-

      - name: Cache frontend build
        id: frontend-cache-win
        uses: actions/cache@v4
        with:
          path: dist
          key: frontend-${{ runner.os }}-${{ hashFiles('src/**', 'package-lock.json', 'vite.config.ts') }}
          restore-keys: frontend-${{ runner.os }}-

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Configure sccache
        run: |
          echo "RUSTC_WRAPPER=sccache" >> $env:GITHUB_ENV
          echo "SCCACHE_GHA_ENABLED=true" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          shared-key: "windows-v1"
          save-if: true
          cache-all-crates: true

      - name: Install frontend dependencies
        if: steps.frontend-cache-win.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build frontend
        if: steps.frontend-cache-win.outputs.cache-hit != 'true'
        run: npm run build

      - name: Build Tauri app
        run: npm run tauri build

      - name: Rename MSI file
        run: |
          $msiFile = Get-ChildItem -Path "src-tauri/target/release/bundle/msi" -Filter "*.msi" | Select-Object -First 1
          if ($msiFile) {
            # Replace spaces with underscores and remove version number
            $newName = $msiFile.Name -replace ' ', '_' -replace '_\d+\.\d+\.\d+', ''
            if ($newName -ne $msiFile.Name) {
              Rename-Item -Path $msiFile.FullName -NewName $newName
            }
          }
        shell: pwsh

      - name: Report sccache stats
        if: always()
        run: sccache --show-stats

      - name: Upload Windows MSI to release
        uses: softprops/action-gh-release@v2
        with:
          files: src-tauri/target/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
